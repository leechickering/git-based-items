---
itemId:sw-240
itemType: Software Item Spec
itemTitle: Detail Design Aspect 5: Mako Plan View
itemFulfills: Display Focus view ,Legend display angle ,MMA-2855,MMA-2961,MMA-2962,MMA-2963,MMA-2964,MMA-2965,MMA-2966,MMA-2967,MMA-2968,MMA-2969,MMA-2970,MMA-2971,MMA-2972,MMA-2973,MMA-2974,MMA-2975,MMA-2976,MMA-2977,MMA-2978,MMA-2979,MMA-2980,MMA-2981,MMA-2982,MMA-2983,MMA-2984,MMA-2985,MMA-2986,MMA-2987,MMA-2988,MMA-2989,MMA-2990,MMA-2991,MMA-2992,MMA-2993,MMA-2994,MMA-2995,MMA-2996,MMA-2997,MMA-2998,MMA-2999,MMA-3000,MMA-3001,MMA-3002,MMA-3003,MMA-3004,MMA-3005,MMA-3006,MMA-3007,MMA-3008,MMA-3010,MMA-3011,MMA-3012,MMA-3013,MMA-3014,MMA-3015,MMA-3016,MMA-3017,MMA-3020,MMA-3021,MMA-3022,MMA-3023,MMA-3024,MMA-3025,MMA-3026,MMA-3027,MMA-3028,MMA-3029,MMA-3030,MMA-3032,MMA-3033,MMA-3034,MMA-3035,MMA-3036,MMA-3037,MMA-3038,MMA-3039,MMA-3040,MMA-3041,MMA-3042,MMA-3043,MMA-3044,MMA-3045,MMA-3046,MMA-3047
itemHasParent: sw-238
Software item type: SDD
---
The Mako Plan View includes the Mako Plan Feature and two Swift UI views: Mako Plan View and Zoom In View. 

The Mako Plan Feature responds when user taps a case in Case List Screen. The feature contains following properties: 
1. MakoPlanViewOption, which maintains state of bottom toggles (Reset, Limb, Implant, Resection, CT, Axes and Landmark). The CT View toggle is shown only on iOS.
2. Procedure, which has procedure details.
3. ProcedureResources, such as, femur, tibia, implant, poly, fibula information.
4. ProcedureResourcesCut, which is resected femur or resected tibia information.
5. BoneModel, which is array of bone model used by Mako Plan View.

The Mako Plan feature contains following actions:
1. fetchProcedureDetails, which retrieves procedure details.
2. fetchProcedureResources, which retrieves femur, tibia, implant, poly and fibula information.
3. fetchProcedureResourcesCut, which retrieves cutting boxes information for both femur and tibia.
4. loadResource, which loads femur, tibia, implant, poly and fibula models per ProcedureResources information.
5. Perform a preview of the resection operation that resects femur and tibia, and then loaded the resected preview of femur and tibia
6. loadResourceCut, which calls the StrykerOCCT bone cut unit to resect femur and tibia, then load resected femur and tibia.
7. updateBoneModel, this action populates loaded models and resected models into BoneModel array property.
8. updateReviewState, this action is used to update review status.
9. updateProcedure, this action is used to set Procedure property.
10. updateProcedureResources, this action is used to set ProcedureResources property.
11. updateProcedureResourcesCut, this action is used to set ProcedureResourcesCut property.
 
Make Plan View has 6 child views:
1. Coronal Femur
2. Coronal Tibia
3. Transverse Femur
4. Transverse Tibia
5. Sagittal Femur
6. Sagittal Tibia

All 6 child views are 3D model views. For iOS, it is ARView. For visionOS, it is RealityView. 3D models are rotatable and zoomable.

When the Mako Plan View is launched, the following tasks are triggered:
1. Call the Mako Plan feature’s updateReviewState action to update reviewed status.
2. Call the Mako Plan feature’s fetchProcedureDetails action to retrieve the procedure details.
3. Call the Mako Plan feature’s fetchProcedureResources action to retrieve femur, tibia, poly, implant, fibula models information.
4. Call the Mako Plan feature’s loadResources action to retrieve femur, tibia, poly, implant, fibula models for Coronal Views.
5. When above actions are done, display whole bone models.
6. Then call the Mako Plan feature’s loadResourceCut action to resect femur and tibia. During resection, Resection toggle is hidden and progress view is displayed. When resection is done, Resection toggle is visible.
7. Deformity values are displayed in the Mako Plan View.

There are toggle buttons located at bottom of the Mako Plan View:
1. Reset toggle which sets 3D models to original position and rotation.
2. Limb toggle which displays limb image.
3. Implant toggle which shows or hides implant.
4. Resection toggle which show or hide resected femur and tibia.
5. CT View toggle which shows or hides CT Views. This toggle is displayed only on iOS.
6. Axes toggle which show or hide Axes lines and values
7. Landmark toggle which show or hide landmarks.
 
Zoom In View
When user taps one of 6 child views, Zoom In View is launched. It is sheet in SwiftUI. Zoom In View uses the bone model from the Mako Plan Feature BoneModel property.  With Zoom In View, the bone model is displayed in larger size. Also rotation, zoom in/out and bottom toggles are supported in the Zoom In View.
 
 
3D Model Transformations
3D models are classified three categories:
1. Regular 3D models: femur, tibia, implant, poly, fibula
	Femur, tibia, implant and poly are downloaded from backend server. Fibula is stored in myMakoData library. To work around a memory leak bugs in Apple's RealityKit, the MyMakoApp: converts STL files to USDC on iOS only before loading. Additionally it avoids removing Entities before re-adding where possible while keeping the same behavior, and caches a single instance of the reusable materials entity.
2. Resected femur and resected tibia use additional libraries to perform the resection.
	StrykerOCCT library is custom built C++ library.
	VTK is an open source C++ library that is embedded into StrykerOCCT.
	To perform femur and tibia resection, the VTK variant of StrykerOCCT is called first. If VTK fails to produce an output, it will use a fallback StrykerOCCT component to perform a slower, more reliable resection algorithm. The resection is only done once. The resected femur and tibia are stored locally and managed via custom built File Manager. The resection is only done once. Resected femur and tibia are stored locally and managed via custom built File Manager.
3. Axes and landmarks 
	Both axes and landmarks are drawn in the myMako App.

When the 3D models are rendered, there are different transforms on different views. The transform matrix is provided by the backend. Inside procedure details, there is a ModelMetaData object. ModelMetaData has:
1. anatomyToBoneFemur
	This is matrix for femur.
2. anatomyToBoneTibia
	This is matrix for tibia.
3. femurTransform
	This is matrix for femur implant.
4. tibiaTransform
	This is matrix for tibia implant.
5. fibulaTransform
	This is matrix for fibula.
6. constitutionalLandmarks
	This is for landmark.
7. resectionLandmarks
	This is for landmark.
8. lineAngles
	This is for axes.
9. hipCenter
	This is for axes.
10. medialEpicondyle
	This is for axes.
11. lateralEpicondyle
	This is for axes.
12. trochlearCenter
	This is for axes.
13. ankleCenter
	This is for axes.
14. kneeCenterTibia
	This is for axes.

Sample transform is listed as below:
let femoralBoneMatrixInverse = convertDoubleToMatrix(doubles: anatomyToBoneFemur)?.inverse
let femoralBoneMatrixCorrected = millimeterMatrixToMetersMatrix(matrix: boneMatrixInverse)
boneModel.femur?.transform.matrix = femoralBoneMatrixCorrected

Bone Resections

When the patient is first viewed, both femur and tibia will be resected real time by the DataClient. The UI is not aware of how the resection is done, but awaits a URL to the resected file which it then loads into the 3D view.
 
CT Views (iOS only)
When user taps CT View toggle in Mako Plan View, CT Views will be displayed. There are 6 CT Views: 
1. Coronal femur CT View
2. Coronal tibia CT View
3. Transverse femur CT View 
4. Transverse tibia CT View 
5. Sagittal femur CT View 
6. Sagittal tibia CT View 


Each CT View contains a CT Scene which has CT slicing image and the bone model. When user taps a case from the Case List screen, CT NRRD file is downloaded from the server (and only download once). The StrykerImaging library processes the CT NRRD file and generates slicing images. The image is overlaid over the slicing bone model. The slicing position can be changed via vertical slider.

Landmarks and axes can be added into the CT Scene so that user can toggle on/off those too. 

CT Images have brightness and contrast parameters. The app applies default values coming from backend with each plan until the user adjusts them. When user changes brightness and contrast, those values will be saved to local database. The default brightness and contrast values are overwritten.

There are two sliders for that purpose. Brightness and contrast are converted to Window Level and Window Width for the CT Scene to consume them. The mapping function is converted from Mako Application. 
 